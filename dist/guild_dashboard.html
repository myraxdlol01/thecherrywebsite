<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ guild.name }} - Cherry Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <div class="user-info">
            <img src="{{ user.avatar_url }}" alt="{{ user.name }}" class="avatar">
            <span>{{ user.name }}</span>
        </div>
        <nav>
            <a href="{{ url_for('index') }}">Servers</a>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </nav>
    </header>

    <main>
        <div class="guild-header">
            {% if guild.icon_url %}
            <img src="{{ guild.icon_url }}" alt="{{ guild.name }}" class="guild-icon">
            {% else %}
            <div class="guild-icon-placeholder">{{ guild.name[:2] }}</div>
            {% endif %}
            <h1>{{ guild.name }}</h1>
        </div>

        <div class="dashboard-grid">
            <!-- Server Stats -->
            <div class="dashboard-card">
                <h3>Server Overview</h3>
                <div class="stat-grid">
                    <div class="stat-item" id="member-count">
                        <div class="stat-number">Loading...</div>
                        <div class="stat-label">Members</div>
                    </div>
                    <div class="stat-item" id="channel-count">
                        <div class="stat-number">Loading...</div>
                        <div class="stat-label">Channels</div>
                    </div>
                    <div class="stat-item" id="role-count">
                        <div class="stat-number">Loading...</div>
                        <div class="stat-label">Roles</div>
                    </div>
                    <div class="stat-item" id="command-count">
                        <div class="stat-number">Loading...</div>
                        <div class="stat-label">Commands Used</div>
                    </div>
                </div>
            </div>

            <!-- Welcome System -->
            <div class="dashboard-card">
                <h3>Welcome System</h3>
                <form id="welcome-form">
                    <div class="form-group">
                        <label for="welcome-channel">Welcome Channel</label>
                        <select id="welcome-channel" name="welcome_channel" class="form-input">
                            <option value="">Select Channel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="welcome-message">Welcome Message</label>
                        <textarea id="welcome-message" name="welcome_message" class="form-input" rows="3">{{ settings.welcome_message }}</textarea>
                        <small>Use {user} for username and {server} for server name</small>
                    </div>
                    <button type="submit" class="form-button">Save Changes</button>
                </form>
            </div>

            <!-- Leveling System -->
            <div class="dashboard-card">
                <h3>Leveling System</h3>
                <form id="leveling-form">
                    <div class="form-group">
                        <label for="leveling-enabled">Enable Leveling</label>
                        <input type="checkbox" id="leveling-enabled" name="leveling_enabled" {% if settings.leveling_enabled %}checked{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="xp-rate">XP Rate</label>
                        <input type="range" id="xp-rate" name="xp_rate" min="1" max="5" value="{{ settings.xp_rate }}" class="form-input">
                        <span id="xp-rate-value">{{ settings.xp_rate }}x</span>
                    </div>
                    <button type="submit" class="form-button">Save Changes</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Fetch server stats
        async function fetchStats() {
            try {
                const response = await fetch(`/api/guild/{{ guild.id }}/stats`);
                const data = await response.json();
                
                document.querySelector('#member-count .stat-number').textContent = data.members;
                document.querySelector('#channel-count .stat-number').textContent = data.channels;
                document.querySelector('#role-count .stat-number').textContent = data.roles;
                document.querySelector('#command-count .stat-number').textContent = data.commands_used;
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        // Update XP rate display
        document.getElementById('xp-rate').addEventListener('input', function(e) {
            document.getElementById('xp-rate-value').textContent = e.target.value + 'x';
        });

        // Handle form submissions
        document.getElementById('welcome-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch(`/api/guild/{{ guild.id }}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        welcome_channel: formData.get('welcome_channel'),
                        welcome_message: formData.get('welcome_message')
                    })
                });
                if (response.ok) {
                    alert('Welcome settings saved!');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        });

        document.getElementById('leveling-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch(`/api/guild/{{ guild.id }}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        leveling_enabled: formData.get('leveling_enabled') === 'on' ? 1 : 0,
                        xp_rate: parseInt(formData.get('xp_rate'))
                    })
                });
                if (response.ok) {
                    alert('Leveling settings saved!');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        });

        // Initial load
        fetchStats();
    </script>
</body>
</html> 