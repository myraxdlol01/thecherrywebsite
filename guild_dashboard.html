<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Server Settings - Cherry Dashboard</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <header>
        <img src="bot-avatar.jpg" alt="cherrybot avatar" class="bot-avatar" />
        <h1>server settings</h1>
        <p>customize cherry for your server</p>
    </header>

    <nav>
        <ul class="nav-list">
            <li><a href="index.html">home</a></li>
            <li><a href="commands.html">commands</a></li>
            <li><a href="dashboard.html">dashboard</a></li>
            <li><a href="premium.html">premium</a></li>
            <li><a href="faq.html">faq</a></li>
            <li><a href="https://discord.gg/cheriez" target="_blank">support</a></li>
        </ul>
    </nav>

    <main id="main-content">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading server settings...</p>
        </div>
    </main>

    <footer>
        <p>made with care by chérie</p>
    </footer>

    <script>
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.createElement('p');
            debugInfo.style.textAlign = 'center';
            debugInfo.style.color = '#666';
            debugInfo.style.fontSize = '12px';
            debugInfo.style.marginTop = '10px';
            debugInfo.textContent = message;
            document.getElementById('main-content').appendChild(debugInfo);
        }

        function showLoginCard() {
            window.location.href = 'dashboard.html';
        }

        function showGuildSettings(guildData) {
            const mainContent = document.getElementById('main-content');
            
            mainContent.innerHTML = `
                <div class="dashboard-container">
                    <div class="guild-info">
                        <img src="${guildData.icon 
                            ? `https://cdn.discordapp.com/icons/${guildData.id}/${guildData.icon}.png` 
                            : 'bot-avatar.jpg'}" 
                            alt="${guildData.name}" class="server-icon">
                        <h2>${guildData.name}</h2>
                        <a href="dashboard.html" class="back-button">← Back to Servers</a>
                    </div>
                    
                    <div class="settings-grid">
                        <div class="settings-card">
                            <h3>Welcome Message</h3>
                            <div class="setting-group">
                                <label for="welcome-enabled">Enable Welcome Messages:</label>
                                <input type="checkbox" id="welcome-enabled" 
                                       ${guildData.settings?.welcome_enabled ? 'checked' : ''}>
                            </div>
                            <div class="setting-group">
                                <label for="welcome-channel">Welcome Channel:</label>
                                <select id="welcome-channel">
                                    ${guildData.channels?.map(channel => 
                                        `<option value="${channel.id}" 
                                            ${channel.id === guildData.settings?.welcome_channel ? 'selected' : ''}>
                                            #${channel.name}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="welcome-message">Welcome Message:</label>
                                <textarea id="welcome-message" rows="3">${guildData.settings?.welcome_message || 'Welcome {user} to {server}!'}</textarea>
                                <p class="setting-help">Use {user} for username and {server} for server name</p>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3>Leveling System</h3>
                            <div class="setting-group">
                                <label for="leveling-enabled">Enable Leveling:</label>
                                <input type="checkbox" id="leveling-enabled" 
                                       ${guildData.settings?.leveling_enabled ? 'checked' : ''}>
                            </div>
                            <div class="setting-group">
                                <label for="xp-rate">XP Rate:</label>
                                <input type="range" id="xp-rate" min="0.5" max="2" step="0.1" 
                                       value="${guildData.settings?.xp_rate || 1}">
                                <span id="xp-rate-value">${guildData.settings?.xp_rate || 1}x</span>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3>Auto Roles</h3>
                            <div class="setting-group">
                                <label for="autorole-enabled">Enable Auto Roles:</label>
                                <input type="checkbox" id="autorole-enabled" 
                                       ${guildData.settings?.autorole_enabled ? 'checked' : ''}>
                            </div>
                            <div class="setting-group">
                                <label for="autorole">Default Role:</label>
                                <select id="autorole">
                                    ${guildData.roles?.map(role => 
                                        `<option value="${role.id}" 
                                            ${role.id === guildData.settings?.autorole_id ? 'selected' : ''}>
                                            @${role.name}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-actions">
                        <button onclick="saveSettings()" class="save-button">Save Changes</button>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById('xp-rate').addEventListener('input', function() {
                document.getElementById('xp-rate-value').textContent = this.value + 'x';
            });
        }

        function saveSettings() {
            const guildId = localStorage.getItem('selected_guild_id');
            const token = localStorage.getItem('discord_access_token');
            const settings = {
                welcome_enabled: document.getElementById('welcome-enabled').checked,
                welcome_channel: document.getElementById('welcome-channel').value,
                welcome_message: document.getElementById('welcome-message').value,
                leveling_enabled: document.getElementById('leveling-enabled').checked,
                xp_rate: parseFloat(document.getElementById('xp-rate').value),
                autorole_enabled: document.getElementById('autorole-enabled').checked,
                autorole_id: document.getElementById('autorole').value
            };

            // Here you would typically send these settings to your backend
            debugLog('Settings saved! (Frontend only - backend integration needed)');
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = 'Settings saved successfully!';
            document.querySelector('.settings-actions').appendChild(successMsg);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        function checkAuth() {
            const token = localStorage.getItem('discord_access_token');
            const tokenType = localStorage.getItem('discord_token_type');
            const guildId = localStorage.getItem('selected_guild_id');

            if (!token || !tokenType || !guildId) {
                debugLog('No valid token or guild ID found');
                showLoginCard();
                return;
            }

            debugLog('Fetching guild data...');

            // Fetch guild data
            Promise.all([
                fetch(`https://discord.com/api/guilds/${guildId}`, {
                    headers: {
                        Authorization: `${tokenType} ${token}`
                    }
                }),
                fetch(`https://discord.com/api/guilds/${guildId}/channels`, {
                    headers: {
                        Authorization: `${tokenType} ${token}`
                    }
                }),
                fetch(`https://discord.com/api/guilds/${guildId}/roles`, {
                    headers: {
                        Authorization: `${tokenType} ${token}`
                    }
                })
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([guildData, channels, roles]) => {
                // Combine all data
                guildData.channels = channels.filter(c => c.type === 0); // Text channels only
                guildData.roles = roles.filter(r => r.name !== '@everyone');
                
                // For demo purposes, create some dummy settings
                guildData.settings = {
                    welcome_enabled: true,
                    welcome_channel: channels[0]?.id,
                    welcome_message: 'Welcome {user} to {server}!',
                    leveling_enabled: true,
                    xp_rate: 1,
                    autorole_enabled: false,
                    autorole_id: null
                };
                
                showGuildSettings(guildData);
            })
            .catch(error => {
                debugLog(`Error fetching guild data: ${error.message}`);
                showLoginCard();
            });
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html> 