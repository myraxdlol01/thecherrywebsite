<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>cherry â€¢ logging in</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <h2>logging in...</h2>
        <p>please wait while we complete your login</p>
        <p id="debug-info" class="debug-message"></p>
    </div>

    <script>
        function debugLog(message) {
            console.log(message);
            document.getElementById('debug-info').textContent = message;
        }

        // Get the code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        
        debugLog('checking response parameters...');
        
        if (error) {
            debugLog(`error: ${error} - ${errorDescription}`);
            setTimeout(() => {
                window.location.href = 'dashboard.html?error=' + encodeURIComponent(errorDescription || error);
            }, 2000);
        } else if (code) {
            debugLog('auth code received, exchanging for token...');
            
            // Exchange the code for an access token using our backend service
            fetch('https://cherry-auth.onrender.com/auth/discord/callback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    redirect_uri: 'https://thecherrywebsite.pages.dev/callback.html'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    // Store the token and its expiry
                    localStorage.setItem('discord_access_token', data.access_token);
                    localStorage.setItem('discord_token_type', data.token_type);
                    localStorage.setItem('discord_expires_in', Date.now() + (data.expires_in * 1000));
                    
                    debugLog('token received, redirecting...');
                    window.location.href = 'dashboard.html';
                } else {
                    throw new Error('no access token received');
                }
            })
            .catch(error => {
                debugLog(`error exchanging code: ${error.message}`);
                setTimeout(() => {
                    window.location.href = 'dashboard.html?error=' + encodeURIComponent('Failed to exchange auth code for token');
                }, 2000);
            });
        } else {
            debugLog('no auth code found, redirecting...');
            setTimeout(() => {
                window.location.href = 'dashboard.html?error=' + encodeURIComponent('No authorization code received');
            }, 1000);
        }
    </script>
</body>
</html> 