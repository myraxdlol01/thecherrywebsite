<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>cherry â€¢ logging in</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="discord-login-container">
        <div class="discord-login-card">
            <img src="bot-avatar.jpg" alt="Cherry Bot Logo" class="discord-logo">
            <h2>Logging you in...</h2>
            <p>Please wait while we complete your login.</p>
            <div class="loading-spinner"></div>
            <p id="debug-info" style="margin-top: 20px; font-size: 12px; color: #666;"></p>
        </div>
    </div>

    <script>
        function debugLog(message) {
            console.log(message);
            document.getElementById('debug-info').textContent = message;
        }

        // Get the code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        
        debugLog('Checking response parameters...');
        
        if (error) {
            debugLog(`Error: ${error} - ${errorDescription}`);
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 2000);
        } else if (code) {
            debugLog('Auth code received, exchanging for token...');
            
            // Exchange the code for an access token
            fetch('https://discord.com/api/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    client_id: '1391355916502433874',
                    client_secret: process.env.DISCORD_CLIENT_SECRET, // This should be handled server-side
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: 'https://thecherrywebsite.pages.dev/callback.html'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    // Store the token and its expiry
                    localStorage.setItem('discord_access_token', data.access_token);
                    localStorage.setItem('discord_token_type', data.token_type);
                    localStorage.setItem('discord_expires_in', Date.now() + (data.expires_in * 1000));
                    
                    if (data.refresh_token) {
                        localStorage.setItem('discord_refresh_token', data.refresh_token);
                    }
                    
                    debugLog('Token received and stored, redirecting...');
                    window.location.href = 'dashboard.html';
                } else {
                    throw new Error('No access token received');
                }
            })
            .catch(error => {
                debugLog(`Error exchanging code: ${error.message}`);
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            });
        } else {
            debugLog('No auth code or error found, redirecting to login...');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);
        }
    </script>
</body>
</html> 