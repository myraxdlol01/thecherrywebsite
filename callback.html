<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CherryBot - Authenticating</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <h2>Authenticating</h2>
        <p>Please wait while we complete your login...</p>
    </div>

    <div id="error" class="error-message" style="display: none;">
        <p>Authentication failed. Redirecting back to login...</p>
    </div>

    <script>
        const CLIENT_ID = '1234567890'; // Replace with your actual client ID
        const CLIENT_SECRET = 'your_client_secret'; // Replace with your actual client secret
        const REDIRECT_URI = window.location.origin + '/callback.html';

        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (!code) {
                showError('No authorization code received');
                return;
            }

            try {
                const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
                    method: 'POST',
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        client_secret: CLIENT_SECRET,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI
                    }),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (!tokenResponse.ok) {
                    throw new Error('Token exchange failed');
                }

                const tokenData = await tokenResponse.json();
                
                // Store the token and its expiry time
                localStorage.setItem('discord_token', tokenData.access_token);
                localStorage.setItem('token_expiry', Date.now() + (tokenData.expires_in * 1000));
                
                // Redirect to dashboard
                window.location.href = '/dashboard.html';
            } catch (error) {
                console.error('Authentication failed:', error);
                showError(error.message);
            }
        }

        function showError(message) {
            document.querySelector('.loading-container').style.display = 'none';
            const errorElement = document.getElementById('error');
            errorElement.querySelector('p').textContent = message;
            errorElement.style.display = 'flex';
            
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 3000);
        }

        // Start the callback handling when page loads
        document.addEventListener('DOMContentLoaded', handleCallback);
    </script>
</body>
</html> 