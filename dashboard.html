<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>cherry dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="dashboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <img src="bot-avatar.jpg" alt="cherrybot avatar" class="bot-avatar" />
        <h1>cherry dashboard</h1>
        <p>manage your server settings and view statistics</p>
    </header>

    <nav>
        <ul class="nav-list">
            <li><a href="index.html">home</a></li>
            <li><a href="commands.html">commands</a></li>
            <li><a href="dashboard.html" class="active">dashboard</a></li>
            <li><a href="premium.html">premium</a></li>
            <li><a href="faq.html">faq</a></li>
            <li><a href="https://discord.gg/cheriez" target="_blank">support</a></li>
        </ul>
    </nav>

    <main id="main-content">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading...</p>
        </div>
    </main>

    <footer>
        <p>made with care by ch√©rie</p>
    </footer>

    <script>
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.createElement('div');
            debugInfo.className = 'debug-info';
            debugInfo.textContent = message;
            document.body.appendChild(debugInfo);
            setTimeout(() => debugInfo.remove(), 3000);
        }

        function showLoginCard() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="dashboard-container">
                    <div class="discord-login-card">
                        <img src="bot-avatar.jpg" alt="Discord Logo" class="discord-logo">
                        <h2>Welcome to Cherry Dashboard</h2>
                        <p>Please login with Discord to manage your server settings</p>
                        <a href="https://discord.com/api/oauth2/authorize?client_id=1391355916502433874&response_type=code&redirect_uri=https://thecherrywebsite.pages.dev/callback.html&scope=identify%20guilds" class="button">
                            Login with Discord
                        </a>
                    </div>
                </div>
            `;
        }

        function showDashboard(userData, guilds) {
            const mainContent = document.getElementById('main-content');
            
            // Filter guilds where user has manage server permission
            const managedGuilds = guilds.filter(guild => (guild.permissions & 0x20) === 0x20);
            
            const guildsList = managedGuilds.map(guild => `
                <div class="server-card" onclick="openGuildSettings('${guild.id}')">
                    <img src="${guild.icon 
                        ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` 
                        : 'bot-avatar.jpg'}" 
                        alt="${guild.name}" class="server-icon">
                    <h3>${guild.name}</h3>
                    <p>Click to manage</p>
                </div>
            `).join('');

            mainContent.innerHTML = `
                <div class="dashboard-container">
                    <div class="user-info">
                        <img src="https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png" 
                             alt="${userData.username}" class="user-avatar">
                        <h2>Welcome, ${userData.username}</h2>
                        <button onclick="logout()" class="button">Logout</button>
                    </div>
                    
                    <div class="servers-section">
                        <h2>Your Servers</h2>
                        <div class="servers-grid">
                            ${guildsList}
                        </div>
                    </div>
                </div>
            `;
        }

        function openGuildSettings(guildId) {
            localStorage.setItem('selected_guild_id', guildId);
            window.location.href = `guild_dashboard.html`;
        }

        function checkAuth() {
            const token = localStorage.getItem('discord_access_token');
            const tokenType = localStorage.getItem('discord_token_type');
            const expiresIn = localStorage.getItem('discord_expires_in');

            if (!token || !tokenType || !expiresIn || Date.now() > parseInt(expiresIn)) {
                debugLog('No valid token found');
                showLoginCard();
                return;
            }

            debugLog('Token found, fetching user data...');

            // Fetch user data
            Promise.all([
                fetch('https://discord.com/api/users/@me', {
                    headers: {
                        Authorization: `${tokenType} ${token}`
                    }
                }),
                fetch('https://discord.com/api/users/@me/guilds', {
                    headers: {
                        Authorization: `${tokenType} ${token}`
                    }
                })
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([userData, guilds]) => {
                if (userData.id) {
                    debugLog('User data received');
                    showDashboard(userData, guilds);
                } else {
                    throw new Error('Invalid user data');
                }
            })
            .catch(error => {
                debugLog(`Error fetching user data: ${error.message}`);
                localStorage.clear();
                showLoginCard();
            });
        }

        function logout() {
            debugLog('Logging out...');
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', checkAuth);
        // Check for error messages
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        if (error) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="dashboard-container">
                    <div class="discord-login-card">
                        <img src="bot-avatar.jpg" alt="Discord Logo" class="discord-logo">
                        <h2>Login Failed</h2>
                        <p class="error-message">${error}</p>
                        <a href="https://discord.com/api/oauth2/authorize?client_id=1391355916502433874&response_type=code&redirect_uri=https://thecherrywebsite.pages.dev/callback.html&scope=identify%20guilds" class="button">
                            Try Again
                        </a>
                    </div>
                </div>
            `;
            return;
        }
    </script>
</body>
</html> 